---
title: 'Week 4: Sampling distributions'
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Disclaimer: These labs rely heavily on those developed by Mike Whitlock for his BIOL 300 course at UBC <https://www.zoology.ubc.ca/~whitlock/bio300/>.** In some cases I have used his material *verbatim*, in other cases I have heavily modified them.

## Goals

* Understand the sampling distribution of an estimate
* Investigate sampling error

## Learning the Tools

### Setup

* As in previous labs, install the **dplyr** and **ggplot2** packages if they aren't already installed.
* Install a new package called **sn**

### Creating your own function

*R* has many functions; additional *R* packages like **dplyr** and **ggplot2** add thousands of more function. Nevertheless, it can be useful to write your own function to complete a specific task. Today, we'll write a function to help simulate a sampling distribution. You'll just copy and paste the code, but it will show you how to go about writing your own functions.

You can define a new function at the top of your script, but I prefer to keep all my custom functions associated with a project in their own file. To do that, create a new R script by going to "File > New File > R Script", like you do when create a new file for your lab report.

Next, copy-and-paste the code below into the new file and save the file with the name "functions.R" in your project directory.

```{r}

# Custom function to generate sampling distribution of the sample mean from a numeric vector x with sample size n
sample_mean <- function(x, n, n_sim) {
  
  data.frame(
    sim = gl(n_sim, n),
    Y = sample(x, n * n_sim, replace = TRUE)
  ) %>%
    group_by(sim) %>%
    summarize(Ybar = mean(Y))

}

```

You can name your functions whatever you want, but like variable names, they should be clear, informative, and no longer than necessary. You also need to omit spaces and dashes, so use the `_` instead. Unlike variable names, it's often helpful to call your function name a verb describing the action it performs.

Notice that this function takes three arguments: `x`, `n`, and `n_sim`. `x` will be a numeric vector we want to randomly sample from; `n` is our sample size, so it should be an integer; and `n_sim` is number of simulated samples, so it should also be an integer.

Don't worry too much about the code inside the function. It uses some tricks we haven't gone over yet, but feel free to explore on your own time. It will return a `data.frame` with two columns. The `sim` column will number the simulations from 1 to `n_sim`. The `Ybar` column will report the sample mean ($\bar{Y}$) from the random sample of $n$ observations from `x`.

Once you've copied the `sample_mean()` function into your new R script, save the script as "functions.R".

#### Using `source()` to read *R* code from a file.

Once you've saved the `sample_mean()` function code in "functions.R", that new function is still not available until you execute the code. To do that, use the `source()` function and put the following code near the top of your lab report (below your name, etc.) so that it looks something like this:

```{r, echo = TRUE, eval = FALSE}
# Chris Muir
# Lab Report Week 4

library(dplyr)
library(ggplot2)

source("functions.R")

```

Notice that I've also used the `library()` function to load the **dplyr** and **ggplot2** packages. You should do the same.

```{r, echo = FALSE, eval = TRUE, message=FALSE, warning = FALSE}

library(dplyr)
library(ggplot2)

source("../functions.R")

```

#### Running your new function

Now you should be able to use the `sample_mean()` function. Try this simple example. First, you'll create a "Population" to randomly sample by drawing 100 random numbers from a Normal distribution using the `rnorm()` function. Then, you'll use that vector for the `sample_mean()` function. Your output should look something like mine, but not exactly the same because of random sampling.

```{r}

# Random sample of n = 100 from a Normal distribution with mean of 0 and standard deviation of 1
population <- rnorm(n = 100, mean = 0, sd = 1)
sample_mean(x = population, n = 10, n_sim = 10)

```

On your own, try the `sample_mean()` function with different values of `n` and `n_sim`.

### Generating random numbers

Generating random numbers in *R* can be extremely useful for randomly sampling or generating simulated data to test your statistical methods. In the section above, we used `rnorm()` to randomly sample from a Normal distribution. *R* has lots of similar functions for other probability distributions, e.g. `rbinom()` randomly samples from a Binomial distribution, `rpois()` randomly samples from a Poisson distribution, etc. We'll illustrate this by sampling from skewed distributions to illustrate symmetrical, left-skewed, and right-skewed distributions.

We'll use exciting new functions in the **sn** package for this (don't worry about the details of these distributions.). The code below makes a `data.frame` with a `shape` and a `Y` column. The `shape` column will tell whether `Y` is sampled from a Left Skewed, Not Skewed, or Right Skewed distribution. We used the `rsn(n, alpha = -5)` function to sample from Leaf Skewed Normal distribution,  `rnorm(n)` to sample from an unskewed Normal distribution, and the `rsn(n, alpha = 5)` function to sample from Right Skewed Normal distribution. The `head()` function lets us peak at the first few rows.

```{r, message = FALSE}

library(sn)

n <- 1e4 # Number of random samples
shapes <- c( "Left Skewed", "Not skewed", "Right Skewed")
df <- data.frame(
  shape = rep(shapes, each = n),
  Y = c(rsn(n, alpha = -5), rnorm(n), rsn(n, alpha = 5))
)

head(df)

```

Now let's plot the results using `ggplot()`. We'll introduce a new function `facet_wrap()` that lets us make multiples of the same graphic for different groups. In this case, we'll have seperate facets for each of the `shape` values.

```{r, message = FALSE}

ggplot(df, aes(Y)) +
  facet_wrap(~ shape) +
  geom_histogram() +
  theme_bw()

```

Modify the code above to generate a density plot using the `geom_density()` function. Within `geom_density()`, use the `fill = ...` argument to choose an exciting color. I've chosen tomato. You can see other available colors by running the command `colors()`. Your result should look something like this:

```{r, echo = FALSE, message = FALSE}

ggplot(df, aes(Y)) +
  facet_wrap(~ shape) +
  geom_density(fill = "tomato") +
  theme_bw()

```

## Activties

### Distribution of sample means

Go to the web and open the page at http://www.zoology.ubc.ca/~whitlock/kingfisher/SamplingNormal.htm. This page contains some interactive visualizations that let you play around with sampling to see the distribution of sampling means. Click the button that says “Tutorial” near the bottom of the page and follow along with the instructions.

### Confidence intervals

Go back to the web, and open the page at http://www.zoology.ubc.ca/~whitlock/kingfisher/CIMean.htm. This applet draws confidence intervals for the mean of a known population. Click “Tutorial” again, and follow along.

## Questions

### 1. Sampling distribution of $\bar{Y}$

#### a. Import data

As we did in class, we'll use the leaf size data from Wright *et al.* 2017^[The original paper can be found [here](https://doi.org/10.1126/science.aal4760)]. We'll pretend that this is population of all leaf sizes in the world and look at the properties of random samples from the population.

Use the `read.csv()` and `filter()` functions from last week's lab to:

* import the data as a `data.frame()`
* assign the `data.frame()` with the name `leafsize`
* use `filter()` to remove missing values from the `leafsize_cm2` column

If you've done everything correctly, you should get the same values for the population mean and standard deviation seen below:

```{r, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

leafsize <- read.csv("../Data/wright_etal_2017.csv") %>% 
  filter(!is.na(leafsize_cm2))

```

```{r, message = FALSE, warning = FALSE}

mean(leafsize$leafsize_cm2)
sd(leafsize$leafsize_cm2)

```

#### b. Sampling distributions for $n = 64$, $n = 256$, and $n = 1024$

Now we'll use our new `sample_mean()` function to look at how the sampling distribution of the sample mean changes with $n$, the sample size. First, let's do a small example with $n = 64$ and 10 simulations. Your results should be similar, but not identical because of random sampling.

```{r}

# define our population
population <- leafsize$leafsize_cm2

n <- 64 # sample size
n_sim <- 10 # number of simulations

sample_dist <- sample_mean(x = population, n = n, n_sim = n_sim)

# extract sample means from sample_dist
sample_dist$Ybar

```

Now, increase the number of simulations to 1000 (`n_sim <- 1000`) and try generate the figures below by (heavily) modifying the code we used above on randomly sampling from distributions with different skew. First, try on your own, and if you get stuck, you can unhide my code. A few hints:

* Rather than using `rnorm()`, use `sample_mean()` with different values of $n$
* To create facets in single column rather than a row, use this code `  facet_wrap(~ sample_size, ncol = 1)`

<details>
  <summary>Show code</summary>
  ```{r, eval = FALSE}
  
  n_sim <- 1e3
  sample_sizes <- c("a. n = 64", "b. n = 256", "c. n = 1024")
  df <- data.frame(
    sample_size = rep(sample_sizes, each = n_sim),
    Ybar = c(
      sample_mean(x = population, n = 64, n_sim = n_sim)$Ybar,
      sample_mean(x = population, n = 256, n_sim = n_sim)$Ybar,
      sample_mean(x = population, n = 1024, n_sim = n_sim)$Ybar
    )
  )

  ggplot(df, aes(Ybar)) +
    facet_wrap(~ sample_size, ncol = 1) +
    xlab("Sample mean") +
    geom_histogram() +
    theme_bw()
  
  ```
</details>

```{r, echo = FALSE, eval = TRUE, message = FALSE}

  n_sim <- 1e3
  sample_sizes <- c("a. n = 64", "b. n = 256", "c. n = 1024")
  df <- data.frame(
    sample_size = rep(sample_sizes, each = n_sim),
    Ybar = c(
      sample_mean(x = population, n = 64, n_sim = n_sim)$Ybar,
      sample_mean(x = population, n = 256, n_sim = n_sim)$Ybar,
      sample_mean(x = population, n = 1024, n_sim = n_sim)$Ybar
    )
  )

  ggplot(df, aes(Ybar)) +
    facet_wrap(~ sample_size, ncol = 1) +
    xlab("Sample mean") +
    geom_histogram() +
    theme_bw()

```

Again, modify the code to make a density plot like this:

```{r, echo = FALSE, eval = TRUE, message = FALSE}

ggplot(df, aes(Ybar)) +
  facet_wrap(~ sample_size, ncol = 1) +
  xlab("Sample mean") +
  geom_density(fill = "tomato") +
  theme_bw()

```

#### c. How does the location, width, and skew of the sampling distribution for $\bar{Y}$ change as $n$ increases?

### 2. WORDS

* SE
* confidence interval

